@startuml
title Viewing Records Management + Statistics & Visualization (Integrated)

package "Shared" {
  class Viewing_Records <<PHP>> {
    +register_shortcodes()
    +enqueue_assets()
    +register_viewing_post_type()
    +register_rest_routes()
    +shortcode_viewing_manager()
    +shortcode_statistics()
    +shortcode_custom_chart()
    +shortcode_viewing_overview()
    +rest_viewings_list(req)
    +rest_viewings_get(req)
    +rest_viewings_create(req)
    +rest_viewings_update(req)
    +rest_viewings_delete(req)
    +rest_upload_image(req)
    +rest_statistics(req)
    +rest_statistics_details(req)
    +rest_statistics_export(req)
    +rest_overview(req)
  }
  
  class ViewingRecord {
    +id: int
    +title: string
    +category: string
    +theater: string
    +cast: string
    +price: string
    +view_date: string
    +view_time_start: string
    +view_time_end: string
    +notes: string
    +ticket_image_id: int
    +ticket_image_url: string
    +author: string
    +url: string
  }
  
  class RESTClient <<JS>> {
    +viewings: string
    +uploadImage: string
    +statistics: string
    +statisticsDetails: string
    +statisticsExport: string
    +overview: string
    +nonce: string
  }
  
  class Assets <<Bundle>> {
    +integrations.js
    +integrations.css
    +Chart.js
    +FullCalendar
  }
}

package "Viewing Records Management" {
  class ViewingManager <<JS>> {
    +initViewingManager()
    +loadListView()
    +initCalendarView()
    +editViewing(id)
    +deleteViewing(id)
    +resetForm()
    +initFormDateInputs()
    +initImageUpload()
    +handleImageUpload(input, previewSelector, imageIdSelector)
    +initDateInput(textInputSelector, datePickerSelector)
    +initTimeValidation(startSelector, endSelector)
    +timeToMinutes(timeStr)
    +escapeHtml(text)
  }
  
  class OCRService <<PHP/JS>> {
    +rest_ocr(image)
    +default_baidu_ocr(bytes)
    +default_aliyun_ocr(bytes)
    +extract_title(text)
    +extract_theater(text)
    +extract_cast(text)
    +extract_price(text)
    +extract_date(text)
  }
  
  class CalendarView <<JS>> {
    +FullCalendar.Calendar
  }
}

package "Statistics & Visualization" {
  class StatisticsData {
    +category: Map<string,int>
    +cast: Map<string,int>
    +price: Map<string,int>
    +theater: Map<string,int>
  }
  
  class StatisticsModule <<JS>> {
    +loadStatistics(callback)
    +renderCategoryChart(data)
    +renderCastChart(data)
    +renderPriceChart(data)
    +generateChart(dataType, chartType, instanceId)
    +renderDynamicChart(data, chartType, dataType, instanceId)
    +getChartOptions(chartType, dataType)
    +getDatasetLabel(dataType)
    +showDetails(type, value)
    +exportStatistics()
    +loadOverview(instanceEl)
  }
  
  class ChartJS <<Lib>> {
  }
  
  class DetailsModal <<JS>> {
    +open()
    +update(content)
  }
  
  class ExportService <<JS>> {
    +export(format)
  }
}

ViewingManager --> RESTClient : uses
StatisticsModule --> RESTClient : uses
RESTClient --> Viewing_Records : calls
Viewing_Records --> ViewingRecord : returns/aggregates
ViewingManager --> ViewingRecord : CRUD
StatisticsModule --> StatisticsData : reads
StatisticsModule --> ChartJS : renders
StatisticsModule --> DetailsModal : opens
ExportService --> RESTClient : exports
ViewingManager ..> OCRService : triggers
ViewingManager ..> CalendarView : controls

ViewingManager --> Assets
StatisticsModule --> Assets

@enduml
